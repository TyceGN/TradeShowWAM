<!DOCTYPE html> 
<html>
<head>
  <meta charset="UTF-8">
  <title>Whack-a-Mole Game</title>
  <!-- Load Phaser from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <!-- Recommended Google Fonts links for Pixelify Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
  <!-- Load WebFont Loader -->
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
  <style>
    body { margin: 0; }
    canvas { image-rendering: pixelated; }
  </style>
</head>
<body>
<script>
  // Define the GameScene class
  class GameScene extends Phaser.Scene {
    constructor() {
      super({ key: 'GameScene' });
      this.score = 0;
      this.gameTime = 30; // 30-second timer
      
      // Fixed total moles (features 1 & 3)
      this.totalMolesToSpawn = 40; // Increased total
      this.totalMolesSpawned = 0;
    }

    preload() {
      // Load the background and mole assets.
      this.load.image('background', 'assets/background.png');
      // For feature 4: load multiple mole images.
      this.load.image('mole1', 'assets/mole1.png');
      this.load.image('mole2', 'assets/mole2.png');
      this.load.image('mole3', 'assets/mole3.png');
      this.load.image('mole4', 'assets/mole4.png');
      this.load.image('mole5', 'assets/mole5.png');
      this.load.image('mole6', 'assets/mole6.png');
      // load background music and sounds
      this.load.audio('bgMusic', 'assets/bgMusic.mp3');
    }

    create() {
      // Add the background (assuming 800x600).
      this.add.image(400, 300, 'background');

      // Initialize hole positions and occupancy tracking (9-hole grid).
      this.holePositions = [
        { x: 110, y: 506 },
        { x: 385, y: 506 },
        { x: 660, y: 506 },
        { x: 130, y: 362 },
        { x: 405, y: 362 },
        { x: 684, y: 362 },
        { x: 120, y: 252 },
        { x: 395, y: 252 },
        { x: 670, y: 252 }
      ];
      this.holeOccupied = new Array(this.holePositions.length).fill(false);

      // Initialize mole keys for multiple mole types.
      this.moleKeys = ['mole1', 'mole2', 'mole3', 'mole4', 'mole5', 'mole6'];

      // Create UI elements (score and timer).
      this.createUI();

      // Create a group for moles.
      this.moles = this.physics.add.group();

      // Show the start menu.
      this.startMenu();
    }

    // Create UI elements for score and timer.
    createUI() {
      console.log('Creating UI elements with Pixelify Sans');
      this.scoreText = this.add.text(16, 16, 'Score: 0', { 
        fontSize: '32px',
        fontFamily: '"Pixelify Sans"',
        fill: '#fff'
      });
      this.timerText = this.add.text(400, 100, 'Time: ' + this.gameTime, { 
        fontSize: '42px',
        fontFamily: '"Pixelify Sans"',
        fill: '#F29305'
      }).setOrigin(0.5, 0.5);
    }

    // Start menu: displays a title and a "Start Game" button.
    startMenu() {
      const boxWidth = 600;
      const boxHeight = 300;
      const boxX = (800 - boxWidth) / 2;
      const boxY = (600 - boxHeight) / 2;
      this.menuGraphics = this.add.graphics();
      this.menuGraphics.fillStyle(0xffffff, 1);
      this.menuGraphics.fillRect(boxX, boxY, boxWidth, boxHeight);
      this.menuGraphics.lineStyle(4, 0xff0000, 1);
      this.menuGraphics.strokeRect(boxX, boxY, boxWidth, boxHeight);

      // Title text (smaller)
      this.titleSmall = this.add.text(400, boxY + 50, 'eG Innovations Presents:', { 
        fontSize: '24px',
        fontFamily: '"Pixelify Sans"',
        fill: '#000'
      }).setOrigin(0.5, 0.5);

      // Main title text (larger, bold)
      this.titleLarge = this.add.text(400, boxY + 120, 'IT Whack-A-Mole', { 
        fontSize: '48px',
        fontFamily: '"Pixelify Sans"',
        fill: '#000',
        fontStyle: 'bold'
      }).setOrigin(0.5, 0.5);

      // "Start Game" button at the bottom.
      this.startButton = this.add.text(400, boxY + boxHeight - 50, 'Start Game', { 
        fontSize: '36px',
        fontFamily: '"Pixelify Sans"',
        fill: '#F29305',
        backgroundColor: '#000'
      }).setOrigin(0.5, 0.5).setInteractive();

      // When the Start Game button is clicked, remove the menu and begin the "Ready/Set/Go" sequence.
      this.startButton.on('pointerdown', () => {
        this.menuGraphics.destroy();
        this.titleSmall.destroy();
        this.titleLarge.destroy();
        this.startButton.destroy();
        // Start the Ready/Set/Go sequence.
        this.startSequence();
      });
    }

    // Start sequence: flash "Ready", then "Set", then "Go" in a box.
    startSequence() {
      const boxWidth = 400;
      const boxHeight = 150;
      const boxX = (800 - boxWidth) / 2;
      const boxY = (600 - boxHeight) / 2;
      this.sequenceGraphics = this.add.graphics();
      this.sequenceGraphics.fillStyle(0xffffff, 1);
      this.sequenceGraphics.fillRect(boxX, boxY, boxWidth, boxHeight);
      this.sequenceGraphics.lineStyle(2, 0xff0000, 1);
      this.sequenceGraphics.strokeRect(boxX, boxY, boxWidth, boxHeight);

      this.sequenceText = this.add.text(400, 300, 'Ready', { 
        fontSize: '60px',
        fontFamily: '"Pixelify Sans"',
        fill: '#000',
        fontStyle: 'bold'
      }).setOrigin(0.5, 0.5);

      // Change text every second.
      this.time.addEvent({ delay: 1000, callback: () => { this.sequenceText.setText('Set'); } });
      this.time.addEvent({ delay: 2000, callback: () => { this.sequenceText.setText('Go'); } });
      // After 3 seconds, remove the sequence and delay 1 second, then start the game.
      this.time.addEvent({
        delay: 3000,
        callback: () => {
          this.sequenceGraphics.destroy();
          this.sequenceText.destroy();
          this.time.addEvent({
            delay: 1000,
            callback: this.startGame,
            callbackScope: this
          });
        }
      });
    }

    // Start the game: begin timer countdown and schedule mole spawns.
    startGame() {
      this.time.addEvent({
        delay: 1000,
        callback: () => {
          this.gameTime--;
          this.timerText.setText('Time: ' + this.gameTime);
          if (this.gameTime <= 0) {
            this.time.removeAllEvents();
            this.time.addEvent({
              delay: 500,
              callback: this.showGameOver,
              callbackScope: this
            });
          }
        },
        callbackScope: this,
        loop: true
      });
      this.scheduleNextMole();
    }

    // Display Game Over UI.
    showGameOver() {
      const boxWidth = 400;
      const boxHeight = 150;
      const boxX = (800 - boxWidth) / 2;
      const boxY = (600 - boxHeight) / 2;
      let graphics = this.add.graphics();
      graphics.fillStyle(0xffffff, 1);
      graphics.fillRect(boxX, boxY, boxWidth, boxHeight);
      graphics.lineStyle(2, 0xff0000, 1);
      graphics.strokeRect(boxX, boxY, boxWidth, boxHeight);

      this.add.text(400, 300, 'Game Over!', { 
        fontSize: '60px',
        fontFamily: '"Pixelify Sans"',
        fill: '#f00',
        fontStyle: 'bold'
      }).setOrigin(0.5, 0.5);
    }

    // Schedule the next mole spawn with a dynamic delay.
    scheduleNextMole() {
      if (this.gameTime <= 0 || this.totalMolesSpawned >= this.totalMolesToSpawn) {
        return;
      }
      // Dynamic delay: maximum decreases from 1500ms at gameTime=30 to 500ms at gameTime=0.
      let maxDelay = 500 + (this.gameTime / 30) * 1000;
      let nextDelay = Phaser.Math.Between(500, Math.floor(maxDelay));
      this.time.addEvent({
        delay: nextDelay,
        callback: this.spawnMole,
        callbackScope: this,
        loop: false
      });
    }

    // Spawn a mole: choose a free hole and create a mole with a random type.
    spawnMole() {
      if (this.totalMolesSpawned >= this.totalMolesToSpawn || this.gameTime <= 0) {
        return;
      }
      this.totalMolesSpawned++;

      // Build list of free hole indices.
      const freeHoleIndices = [];
      for (let i = 0; i < this.holePositions.length; i++) {
        if (!this.holeOccupied[i]) {
          freeHoleIndices.push(i);
        }
      }
      if (freeHoleIndices.length === 0) {
        this.scheduleNextMole();
        return;
      }
      const chosenIndex = Phaser.Math.RND.pick(freeHoleIndices);
      this.holeOccupied[chosenIndex] = true;
      const hole = this.holePositions[chosenIndex];

      // Pick a random mole type.
      const randomKey = Phaser.Math.RND.pick(this.moleKeys);
      let mole = this.moles.create(hole.x, hole.y + 50, randomKey).setInteractive();
      mole.setOrigin(0.45, 1);
      mole.holeIndex = chosenIndex;

      this.tweens.add({
        targets: mole,
        y: hole.y,
        ease: 'Bounce.easeOut',
        duration: 300,
      });

      let moleDuration = 600 + (this.gameTime / 30) * (1500 - 600);

      mole.on('pointerdown', () => {
        if (mole.active) {
          this.holeOccupied[mole.holeIndex] = false;
          mole.destroy();
          this.score += 10;
          this.scoreText.setText('Score: ' + this.score);
        }
      });

      this.time.addEvent({
        delay: moleDuration,
        callback: () => {
          if (mole.active) {
            this.holeOccupied[mole.holeIndex] = false;
            mole.destroy();
          }
        },
        callbackScope: this
      });

      this.scheduleNextMole();
    }
  }

  // Game configuration
  const config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    scale: {
      mode: Phaser.Scale.FIT,
      autoCenter: Phaser.Scale.CENTER_BOTH
    },
    physics: {
      default: 'arcade',
      arcade: { debug: false }
    },
    scene: [GameScene]
  };

  // Use WebFont.load to wait for the custom font to be active before starting the game.
  WebFont.load({
    google: { families: ['Pixelify Sans'] },
    active: function() {
      console.log('Font loaded, creating game instance');
      const game = new Phaser.Game(config);
    }
  });
</script>
</body>
</html>

